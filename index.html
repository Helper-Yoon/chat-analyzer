<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNSì„¼í„° ì±„íŒ…ë¶„ì„ í”„ë¡œê·¸ë¨ v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000000;
            min-height: 100vh;
            color: #FFFFFF;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #1E5AA8 0%, #4A7BC8 100%);
            color: white;
            text-align: center;
            padding: 30px 0;
            box-shadow: 0 4px 20px rgba(30, 90, 168, 0.5);
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            padding: 30px 0;
        }

        .section {
            background: #111111;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.8);
            border: 1px solid #333333;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #1E5AA8;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1E5AA8;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ */
        .file-upload-area {
            border: 2px dashed #1E5AA8;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #0A0A0A;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            background: #1A1A1A;
            border-color: #4A7BC8;
        }

        .file-upload-area.dragover {
            background: #1A1A1A;
            border-color: #4A7BC8;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #1E5AA8;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .file-name {
            margin-top: 15px;
            padding: 10px;
            background: #222222;
            border-radius: 6px;
            border: 1px solid #333333;
            color: #CCCCCC;
        }

        .upload-text {
            color: #FFFFFF;
        }

        .upload-subtext {
            color: #888888;
            font-size: 12px;
        }

        /* í¼ ìš”ì†Œ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #FFFFFF;
        }

        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #333333;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #1A1A1A;
            color: #FFFFFF;
        }

        input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #1E5AA8;
            box-shadow: 0 0 0 3px rgba(30, 90, 168, 0.3);
        }

        /* ë¸Œë¼ìš°ì €ë³„ date input ìŠ¤íƒ€ì¼ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* ë²„íŠ¼ */
        .btn-primary {
            background: linear-gradient(135deg, #1E5AA8 0%, #4A7BC8 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(30, 90, 168, 0.5);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 90, 168, 0.6);
        }

        .btn-primary:disabled {
            background: #333333;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ì§„í–‰ë¥  */
        .progress-container {
            margin: 20px 0;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333333;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1E5AA8, #4A7BC8);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #CCCCCC;
            font-size: 14px;
        }

        /* ë¡œê·¸ */
        .log-container {
            background: #000000;
            color: #00FF00;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid #333333;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-timestamp {
            color: #888888;
        }

        /* ê²°ê³¼ ì˜ì—­ */
        .results {
            display: none;
            margin-top: 30px;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-download {
            background: #1E5AA8;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-download:hover {
            background: #4A7BC8;
            transform: translateY(-1px);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .section {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .download-buttons {
                flex-direction: column;
            }
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #111111;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        th {
            background: #1E5AA8;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #333333;
            text-align: center;
            color: #FFFFFF;
        }

        tr:hover {
            background: #1A1A1A;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }

        .spinner {
            border: 3px solid #333333;
            border-top: 3px solid #1E5AA8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë¡œì»¬ ì²˜ë¦¬ í‘œì‹œ */
        .local-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(30, 90, 168, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 1000;
        }

        /* ê²°ê³¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .result-summary h3 {
            color: #1E5AA8;
            margin-bottom: 15px;
        }

        .result-summary h4 {
            color: #FFFFFF;
            margin: 20px 0 10px 0;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #222222;
        }

        ::-webkit-scrollbar-thumb {
            background: #1E5AA8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4A7BC8;
        }
    </style>
</head>
<body>
    <div class="local-badge">ğŸ”’ ë¡œì»¬ ì²˜ë¦¬</div>
    
    <div class="header">
        <div class="container">
            <h1>SNSì„¼í„° ì±„íŒ…ë¶„ì„ í”„ë¡œê·¸ë¨ v2.0</h1>
            <p>ì™„ì „ ë¡œì»¬ ì²˜ë¦¬ - ì„œë²„ ì—…ë¡œë“œ ì—†ì´ ì•ˆì „í•œ ë¶„ì„</p>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- íŒŒì¼ ì„ íƒ -->
            <div class="section">
                <div class="section-title">1. ë¶„ì„ íŒŒì¼ ì„ íƒ</div>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="file-upload-icon">ğŸ“</div>
                    <div class="upload-text">
                        <strong>ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</strong>
                        <br>
                        <small class="upload-subtext">.xlsx íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤ | íŒŒì¼ì€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤</small>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx" />
                    <div id="fileName" class="file-name" style="display: none;"></div>
                </div>
            </div>

            <!-- ë¶„ì„ ê¸°ê°„ -->
            <div class="section">
                <div class="section-title">2. ë¶„ì„ ê¸°ê°„ ì„¤ì •</div>
                <div class="form-row">
                    <div>
                        <label for="startDate">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" />
                    </div>
                    <div>
                        <label for="endDate">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" />
                    </div>
                </div>
            </div>

            <!-- ë¶„ì„ ì„¤ì • -->
            <div class="section">
                <div class="section-title">3. ë¶„ì„ ëŒ€ìƒ ì„¤ì •</div>
                <div class="form-group">
                    <label for="managers">ê´€ë¦¬ì ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="managers" value="ì´ì¢…ë¯¼, ìœ¤ë„ìš°ë¦¬, ê¹€ì§„í›„, ì´ì¢…ë¯¼, ì°¨ì •í™˜" />
                </div>
                <div class="form-group">
                    <label for="exclusions">ë¶„ì„ ì œì™¸ ëª…ë‹¨ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="exclusions" value="ì±„ì£¼ì€, ì •ìš©ìš±, í•œìŠ¹ìœ¤, ê¹€ì¢…í˜„, ê³µí˜„ì¤€, ê°•í—Œì¤€" />
                </div>
            </div>

            <!-- ì‹¤í–‰ ë²„íŠ¼ -->
            <button id="analyzeBtn" class="btn-primary" onclick="runAnalysis()">
                4. ë¶„ì„ ì‹¤í–‰
            </button>

            <!-- ì§„í–‰ë¥  -->
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text"></div>
            </div>

            <!-- ë¡œê·¸ -->
            <div class="section">
                <div class="section-title">ì§„í–‰ ìƒí™© ë¡œê·¸</div>
                <div id="logContainer" class="log-container"></div>
            </div>

            <!-- ê²°ê³¼ -->
            <div id="results" class="results">
                <div class="section">
                    <div class="section-title">ë¶„ì„ ê²°ê³¼</div>
                    <div id="resultSummary" class="result-summary"></div>
                    <div class="download-buttons">
                        <button class="btn-download" onclick="downloadResults()">
                            ğŸ“Š ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let uploadedFile = null;
        let analysisResults = null;

        // ë‚ ì§œ ì´ˆê¸°í™” - ë‹¹ì›” 1ì¼ë¶€í„° ì–´ì œê¹Œì§€
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            
            // ë‹¹ì›” 1ì¼
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('startDate').value = firstOfMonth.toISOString().split('T')[0];
            
            // ì–´ì œ
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('endDate').value = yesterday.toISOString().split('T')[0];
            
            log('ğŸ¯ ë¡œì»¬ ì²˜ë¦¬ ëª¨ë“œ - íŒŒì¼ì€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
            log(`ğŸ“… ê¸°ë³¸ ë¶„ì„ ê¸°ê°„: ${firstOfMonth.toLocaleDateString()} ~ ${yesterday.toLocaleDateString()}`);
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.querySelector('.file-upload-area');
        const fileName = document.getElementById('fileName');

        fileInput.addEventListener('change', handleFileSelect);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect({ target: { files: files } });
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.xlsx')) {
                uploadedFile = file;
                fileName.textContent = `ì„ íƒëœ íŒŒì¼: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
                fileName.style.display = 'block';
                log(`ğŸ“ íŒŒì¼ ì„ íƒë¨: ${file.name} - ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤`);
            } else {
                alert('âš ï¸ .xlsx íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                fileInput.value = '';
            }
        }

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (percent === 0) {
                progressContainer.style.display = 'none';
                return;
            }
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // ë¶„ì„ ì‹¤í–‰
        async function runAnalysis() {
            if (!uploadedFile) {
                alert('âš ï¸ ë¶„ì„í•  ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="spinner"></div>ë¶„ì„ ì¤‘...';

            try {
                log('ğŸš€ ë¡œì»¬ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
                updateProgress(10, 'íŒŒì¼ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...');

                // íŒŒì¼ ì½ê¸°
                const workbook = await readExcelFile(uploadedFile);
                updateProgress(30, 'ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                // ë°ì´í„° ì²˜ë¦¬
                const processedData = await processData(workbook);
                updateProgress(60, 'ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                // ë¶„ì„ ì‹¤í–‰
                const results = await performAnalysis(processedData);
                updateProgress(90, 'ê²°ê³¼ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                // ê²°ê³¼ í‘œì‹œ
                displayResults(results);
                updateProgress(100, 'ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

                log('âœ… ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                setTimeout(() => {
                    updateProgress(0, '');
                }, 2000);

            } catch (error) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('Analysis error:', error);
                alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                updateProgress(0, '');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '4. ë¶„ì„ ì‹¤í–‰';
            }
        }

        // ì—‘ì…€ íŒŒì¼ ì½ê¸° (ì™„ì „ ë¡œì»¬ ì²˜ë¦¬)
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        log('ğŸ“‹ íŒŒì¼ ì½ê¸° ì™„ë£Œ - ì„œë²„ ì „ì†¡ ì—†ìŒ');
                        resolve(workbook);
                    } catch (error) {
                        reject(new Error('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                    }
                };
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ë°ì´í„° ì²˜ë¦¬
        function processData(workbook) {
            return new Promise((resolve, reject) => {
                try {
                    log('ğŸ“Š ì‹œíŠ¸ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...');
                    
                    // í•„ìˆ˜ ì‹œíŠ¸ ì°¾ê¸°
                    const requiredSheets = ['UserChat data', 'Message data', 'Manager data'];
                    const sheetData = {};
                    
                    for (const required of requiredSheets) {
                        let found = false;
                        for (const sheetName of workbook.SheetNames) {
                            if (sheetName.toLowerCase().includes(required.toLowerCase())) {
                                const worksheet = workbook.Sheets[sheetName];
                                sheetData[required] = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                                found = true;
                                log(`âœ… '${sheetName}' ì‹œíŠ¸ ë°œê²¬ (${sheetData[required].length}ê°œ ë ˆì½”ë“œ)`);
                                break;
                            }
                        }
                        if (!found) {
                            throw new Error(`í•„ìˆ˜ ì‹œíŠ¸ '${required}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        }
                    }

                    // ë‚ ì§œ í•„í„°ë§
                    const startDate = new Date(document.getElementById('startDate').value);
                    const endDate = new Date(document.getElementById('endDate').value);
                    endDate.setDate(endDate.getDate() + 1); // ì¢…ë£Œì¼ í¬í•¨

                    log('ğŸ”„ ë°ì´í„°ë¥¼ ì •ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                    
                    // Message data í•„í„°ë§
                    const filteredMessages = sheetData['Message data'].filter(msg => {
                        if (!msg.createdAt) return false;
                        const msgDate = new Date(msg.createdAt);
                        return msgDate >= startDate && msgDate < endDate;
                    });

                    if (filteredMessages.length === 0) {
                        throw new Error('ì„ íƒëœ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    log(`ğŸ“ˆ ${filteredMessages.length}ê°œì˜ ë©”ì‹œì§€ê°€ ë¶„ì„ ëŒ€ìƒì…ë‹ˆë‹¤.`);

                    resolve({
                        userChat: sheetData['UserChat data'],
                        messages: filteredMessages,
                        managers: sheetData['Manager data']
                    });

                } catch (error) {
                    reject(error);
                }
            });
        }

        // ë¶„ì„ ìˆ˜í–‰
        function performAnalysis(data) {
            return new Promise((resolve, reject) => {
                try {
                    log('ğŸ” ë°ì´í„°ë¥¼ ë³‘í•©í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                    
                    // ê´€ë¦¬ì ë° ì œì™¸ ëª©ë¡
                    const managers = document.getElementById('managers').value
                        .split(',').map(name => name.trim()).filter(name => name);
                    const exclusions = document.getElementById('exclusions').value
                        .split(',').map(name => name.trim()).filter(name => name);

                    log(`ğŸ‘¥ ê´€ë¦¬ì: ${managers.join(', ')}`);
                    log(`ğŸš« ì œì™¸ ëŒ€ìƒ: ${exclusions.join(', ')}`);

                    // ë°ì´í„° ë³‘í•© ë° ë¶„ì„
                    const mergedData = mergeData(data, managers, exclusions);
                    const analysisResult = analyzeData(mergedData, data);
                    
                    analysisResults = analysisResult;
                    resolve(analysisResult);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // ë°ì´í„° ë³‘í•©
        function mergeData(data, managers, exclusions) {
            // ID ì •ì œ í•¨ìˆ˜
            const cleanId = (id) => String(id || '').trim().replace(/\.0$/, '');
            
            // Manager ID-Name ë§¤í•‘
            const managerMap = {};
            data.managers.forEach(manager => {
                const id = cleanId(manager.id);
                if (id && manager.name) {
                    managerMap[id] = manager.name.trim();
                }
            });

            // UserChat ID-AssigneeId ë§¤í•‘
            const chatAssigneeMap = {};
            data.userChat.forEach(chat => {
                const chatId = cleanId(chat.id);
                const assigneeId = cleanId(chat.assigneeId);
                if (chatId && assigneeId) {
                    chatAssigneeMap[chatId] = assigneeId;
                }
            });

            // ë©”ì‹œì§€ ë°ì´í„° ë³‘í•©
            const mergedMessages = [];
            data.messages.forEach(msg => {
                const chatId = cleanId(msg.chatId);
                const personId = cleanId(msg.personId);
                
                if (!chatId || !personId || !msg.plainText) return;
                
                const assigneeId = chatAssigneeMap[chatId];
                const authorName = managerMap[personId];
                
                if (assigneeId && authorName) {
                    mergedMessages.push({
                        chatId,
                        personId,
                        assigneeId,
                        authorName,
                        plainText: msg.plainText,
                        createdAt: msg.createdAt
                    });
                }
            });

            // ë°ì´í„° ë¶„ë¦¬
            const managerData = mergedMessages.filter(msg => managers.includes(msg.authorName));
            const agentData = mergedMessages.filter(msg => 
                !managers.includes(msg.authorName) && !exclusions.includes(msg.authorName)
            );

            log(`ğŸ“Š ë³‘í•© ê²°ê³¼: ì´ ${mergedMessages.length}ê°œ ë©”ì‹œì§€ (ê´€ë¦¬ì: ${managerData.length}, ìƒë‹´ì‚¬: ${agentData.length})`);

            return { merged: mergedMessages, managers: managerData, agents: agentData };
        }

        // ë°ì´í„° ë¶„ì„
        function analyzeData(mergedData, originalData) {
            log('ğŸ“ˆ ìƒë‹´ì‚¬ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
            
            // ìƒë‹´ì‚¬ í•„í„°ë§
            const agentStats = calculateAgentStats(mergedData.agents);
            const filteredAgents = filterAgents(agentStats);
            
            if (filteredAgents.length === 0) {
                throw new Error('í•„í„°ë§ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ìƒë‹´ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            log(`âœ… í•„í„°ë§: ${agentStats.length}ëª… â†’ ${filteredAgents.length}ëª…`);

            // ìƒë‹´ì‚¬ ë¶„ì„
            const agentAnalysis = analyzeGroup(
                mergedData.agents.filter(msg => filteredAgents.includes(msg.authorName)),
                originalData, 'ìƒë‹´ì‚¬'
            );

            // ê´€ë¦¬ì ë¶„ì„
            const managerAnalysis = analyzeGroup(mergedData.managers, originalData, 'ê´€ë¦¬ì');

            return {
                agents: agentAnalysis,
                managers: managerAnalysis,
                filteredCount: filteredAgents.length
            };
        }

        // ìƒë‹´ì‚¬ í†µê³„ ê³„ì‚°
        function calculateAgentStats(agentData) {
            const stats = {};
            
            agentData.forEach(msg => {
                if (!stats[msg.authorName]) {
                    stats[msg.authorName] = {
                        totalChats: new Set(),
                        totalMessages: 0,
                        collabChats: new Set()
                    };
                }
                
                stats[msg.authorName].totalChats.add(msg.chatId);
                stats[msg.authorName].totalMessages++;
                
                if (msg.personId !== msg.assigneeId) {
                    stats[msg.authorName].collabChats.add(msg.chatId);
                }
            });

            return Object.keys(stats).map(authorName => {
                const stat = stats[authorName];
                const totalChats = stat.totalChats.size;
                const collabChats = stat.collabChats.size;
                const hir = totalChats > 0 ? collabChats / totalChats : 0;
                
                return {
                    authorName,
                    totalChats,
                    totalMessages: stat.totalMessages,
                    collabChats,
                    hir
                };
            });
        }

        // ìƒë‹´ì‚¬ í•„í„°ë§
        function filterAgents(agentStats) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const analysisDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const minMessages = analysisDays * 10;

            log(`ğŸ“Š ë¶„ì„ ê¸°ê°„: ${analysisDays}ì¼, ìµœì†Œ ë©”ì‹œì§€: ${minMessages}ê°œ`);

            return agentStats
                .filter(stat => 
                    stat.hir > 0 && 
                    stat.hir < 1 && 
                    stat.totalMessages >= minMessages
                )
                .map(stat => stat.authorName);
        }

        // ê·¸ë£¹ ë¶„ì„
        function analyzeGroup(groupData, originalData, groupName) {
            log(`ğŸ” ${groupName} ê·¸ë£¹ ë¶„ì„ ì¤‘...`);
            
            if (groupData.length === 0) {
                return { summary: [], metrics: [] };
            }

            // ì €ìë³„ ë°ì´í„° ë¶„ë¦¬
            const authorData = {};
            groupData.forEach(msg => {
                if (!authorData[msg.authorName]) {
                    authorData[msg.authorName] = { assignee: [], nonAssignee: [] };
                }
                
                if (msg.personId === msg.assigneeId) {
                    authorData[msg.authorName].assignee.push(msg);
                } else {
                    authorData[msg.authorName].nonAssignee.push(msg);
                }
            });

            const authors = Object.keys(authorData);
            const summary = [];
            const metrics = [];

            authors.forEach(authorName => {
                const assigneeData = authorData[authorName].assignee;
                const nonAssigneeData = authorData[authorName].nonAssignee;

                // ê¸°ë³¸ í†µê³„
                const assigneeStats = calculateBasicStats(assigneeData);
                const nonAssigneeStats = calculateBasicStats(nonAssigneeData);
                
                // ë‹´ë‹¹ ìƒë‹´ ìˆ˜ (originalDataì—ì„œ ê³„ì‚°)
                const assignedChats = calculateAssignedChats(authorName, originalData);
                
                // ì •ì„± ì ìˆ˜
                const qualitativeScores = calculateQualitativeScores(assigneeData, nonAssigneeData);
                
                // ë©”íŠ¸ë¦­ìŠ¤ (ë¹„ë‹´ë‹¹ì ë°ì´í„°ë§Œ)
                const authorMetrics = calculateMetrics(authorName, nonAssigneeData);

                summary.push({
                    ìƒë‹´ì‚¬ëª…: authorName,
                    'ë‹´ë‹¹ ìƒë‹´ ìˆ˜': assignedChats,
                    'ë‹´ë‹¹ ë©”ì‹œì§€ ìˆ˜': assigneeStats.messageCount,
                    'ë‹´ë‹¹ ê¸€ì ìˆ˜': assigneeStats.charCount,
                    'ë„ì›€ ìƒë‹´ ìˆ˜': nonAssigneeStats.chatCount,
                    'ë„ì›€ ë©”ì‹œì§€ ìˆ˜': nonAssigneeStats.messageCount,
                    'ë„ì›€ ê¸€ì ìˆ˜': nonAssigneeStats.charCount,
                    'ë‹´ë‹¹ ì •ì„± ì ìˆ˜': qualitativeScores.assignee.toFixed(2),
                    'ë„ì›€ ì •ì„± ì ìˆ˜': qualitativeScores.nonAssignee.toFixed(2),
                    'ì´ ì •ì„± ì ìˆ˜': (qualitativeScores.assignee + qualitativeScores.nonAssignee).toFixed(2)
                });

                if (nonAssigneeData.length > 0) {
                    metrics.push({
                        ìƒë‹´ì‚¬ëª…: authorName,
                        'ë„ì›€ ê°œì…ë¥ ': authorMetrics.hir.toFixed(3),
                        'ê°œì… ì˜í–¥ë ¥ ê³„ìˆ˜': authorMetrics.iif,
                        'ì½˜í…ì¸  ì •ë³´ ì ìˆ˜': authorMetrics.cis,
                        'ì–¸ì–´ ê¹Šì´ ì ìˆ˜': authorMetrics.dls.toFixed(1),
                        'ì‹ ì²­ì„œ ë§í¬ ì ìˆ˜': authorMetrics.als
                    });
                }
            });

            // ì •ë ¬
            summary.sort((a, b) => parseFloat(b['ì´ ì •ì„± ì ìˆ˜']) - parseFloat(a['ì´ ì •ì„± ì ìˆ˜']));
            metrics.sort((a, b) => parseInt(b['ì‹ ì²­ì„œ ë§í¬ ì ìˆ˜']) - parseInt(a['ì‹ ì²­ì„œ ë§í¬ ì ìˆ˜']));

            return { summary, metrics };
        }

        // ê¸°ë³¸ í†µê³„ ê³„ì‚°
        function calculateBasicStats(messages) {
            const uniqueChats = new Set(messages.map(msg => msg.chatId));
            const totalChars = messages.reduce((sum, msg) => sum + (msg.plainText?.length || 0), 0);
            
            return {
                chatCount: uniqueChats.size,
                messageCount: messages.length,
                charCount: totalChars
            };
        }

        // ë‹´ë‹¹ ìƒë‹´ ìˆ˜ ê³„ì‚°
        function calculateAssignedChats(authorName, originalData) {
            // Manager ID ì°¾ê¸°
            const manager = originalData.managers.find(m => m.name?.trim() === authorName);
            if (!manager) return 0;
            
            const managerId = String(manager.id || '').trim().replace(/\.0$/, '');
            
            // í•´ë‹¹ ê´€ë¦¬ìê°€ ë‹´ë‹¹í•œ ì±„íŒ… ìˆ˜ ê³„ì‚°
            const assignedCount = originalData.userChat.filter(chat => {
                const assigneeId = String(chat.assigneeId || '').trim().replace(/\.0$/, '');
                return assigneeId === managerId;
            }).length;
            
            return assignedCount;
        }

        // ì •ì„± ì ìˆ˜ ê³„ì‚°
        function calculateQualitativeScores(assigneeData, nonAssigneeData) {
            const calculateBaseScore = (messages) => {
                if (messages.length === 0) return 0;
                
                const messageCounts = {};
                messages.forEach(msg => {
                    const text = msg.plainText;
                    messageCounts[text] = (messageCounts[text] || 0) + 1;
                });
                
                const totalMessages = messages.length;
                let score = 0;
                
                messages.forEach(msg => {
                    const frequency = messageCounts[msg.plainText];
                    score += Math.log(totalMessages / frequency + 1);
                });
                
                return score;
            };

            let assigneeScore = calculateBaseScore(assigneeData);
            let nonAssigneeScore = calculateBaseScore(nonAssigneeData);

            // ALS ë³´ì • (ì‹ ì²­ì„œ ë§í¬)
            if (nonAssigneeData.length > 0) {
                const alsCount = nonAssigneeData.filter(msg => 
                    msg.plainText?.includes('https://form.ajd.co.kr/')
                ).length;
                
                const alsBonus = alsCount * 10;
                const alsNormalized = alsBonus / Math.max(1, nonAssigneeData.length);
                nonAssigneeScore *= (1 + alsNormalized * 0.3);
            }

            return {
                assignee: assigneeScore,
                nonAssignee: nonAssigneeScore
            };
        }

        // ë©”íŠ¸ë¦­ìŠ¤ ê³„ì‚°
        function calculateMetrics(authorName, nonAssigneeData) {
            if (nonAssigneeData.length === 0) {
                return { hir: 0, iif: 0, cis: 0, dls: 0, als: 0 };
            }

            // HIR (ê°„ë‹¨ ë²„ì „ - ì‹¤ì œë¡œëŠ” ì „ì²´ ë°ì´í„°ê°€ í•„ìš”)
            const uniqueChats = new Set(nonAssigneeData.map(msg => msg.chatId));
            const hir = 0.5; // í”Œë ˆì´ìŠ¤í™€ë”

            // IIF (ê°œì… ì˜í–¥ë ¥ ê³„ìˆ˜)
            const chatLengths = {};
            nonAssigneeData.forEach(msg => {
                chatLengths[msg.chatId] = (chatLengths[msg.chatId] || 0) + 1;
            });
            const iif = Object.values(chatLengths).reduce((sum, length) => sum + length, 0);

            // CIS (ì½˜í…ì¸  ì •ë³´ ì ìˆ˜)
            const keywords = ['ì›”ìš”ê¸ˆ', 'ì‚¬ì€í’ˆ', 'ìœ„ì•½ê¸ˆ', 'ê²°í•©', 'ì„¤ì¹˜ì¼', 'ì„¤ì¹˜ë¹„', 'ì•½ì •', 'ì§€ì›ê¸ˆ', 'í• ì¸', 'í†µì‹ ì‚¬', 'ìš”ê¸ˆì œ', 'ì¸í„°ë„·', 'íœ´ëŒ€í°'];
            const cis = nonAssigneeData.filter(msg => {
                return keywords.some(keyword => msg.plainText?.includes(keyword));
            }).length;

            // DLS (ì–¸ì–´ ê¹Šì´ ì ìˆ˜)
            const totalChars = nonAssigneeData.reduce((sum, msg) => sum + (msg.plainText?.length || 0), 0);
            const dls = totalChars / nonAssigneeData.length;

            // ALS (ì‹ ì²­ì„œ ë§í¬ ì ìˆ˜)
            const als = nonAssigneeData.filter(msg => 
                msg.plainText?.includes('https://form.ajd.co.kr/')
            ).length * 10;

            return { hir, iif, cis, dls, als };
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('resultSummary');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>ğŸ“Š ë¶„ì„ ì™„ë£Œ!</h3>
                    <p>ì´ ${results.filteredCount}ëª…ì˜ ìƒë‹´ì‚¬ê°€ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;

            // ìƒë‹´ì‚¬ ìš”ì•½ í…Œì´ë¸”
            if (results.agents.summary.length > 0) {
                html += `
                    <h4>ğŸ‘¨â€ğŸ’¼ ìƒë‹´ì‚¬ ë¶„ì„ ê²°ê³¼ (ìƒìœ„ 10ëª…)</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ìˆœìœ„</th>
                                    <th>ìƒë‹´ì‚¬ëª…</th>
                                    <th>ë‹´ë‹¹ ìƒë‹´ ìˆ˜</th>
                                    <th>ë„ì›€ ìƒë‹´ ìˆ˜</th>
                                    <th>ì´ ì •ì„± ì ìˆ˜</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                results.agents.summary.slice(0, 10).forEach((agent, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td><strong>${agent.ìƒë‹´ì‚¬ëª…}</strong></td>
                            <td>${agent['ë‹´ë‹¹ ìƒë‹´ ìˆ˜']}</td>
                            <td>${agent['ë„ì›€ ìƒë‹´ ìˆ˜']}</td>
                            <td><strong>${agent['ì´ ì •ì„± ì ìˆ˜']}</strong></td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            summaryDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadResults() {
            if (!analysisResults) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                log('ğŸ“¥ ê²°ê³¼ íŒŒì¼ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                
                const wb = XLSX.utils.book_new();
                
                // ìƒë‹´ì‚¬ ìš”ì•½ ì‹œíŠ¸
                if (analysisResults.agents.summary.length > 0) {
                    const agentWs = XLSX.utils.json_to_sheet(analysisResults.agents.summary);
                    XLSX.utils.book_append_sheet(wb, agentWs, 'ì±„íŒ…ë¶„ì„_ìš”ì•½');
                }
                
                // ìƒë‹´ì‚¬ ì§€í‘œ ì‹œíŠ¸
                if (analysisResults.agents.metrics.length > 0) {
                    const metricsWs = XLSX.utils.json_to_sheet(analysisResults.agents.metrics);
                    XLSX.utils.book_append_sheet(wb, metricsWs, 'ì±„íŒ…ë¶„ì„_ì§€í‘œ');
                }
                
                // ê´€ë¦¬ì ë¶„ì„ ì‹œíŠ¸
                if (analysisResults.managers.summary.length > 0) {
                    const managerWs = XLSX.utils.json_to_sheet(analysisResults.managers.summary);
                    XLSX.utils.book_append_sheet(wb, managerWs, 'ê´€ë¦¬ì_ë¶„ì„');
                }
                
                // ë„ì›€ë§ ì‹œíŠ¸
                const helpData = [
                    {
                        'êµ¬ë¶„': 'ì •ëŸ‰ ì§€í‘œ',
                        'ì§€í‘œëª…': 'HIR (ë„ì›€ ê°œì…ë¥ )',
                        'ì •ì˜': 'ì „ì²´ ì°¸ì—¬ ìƒë‹´ ì¤‘ í˜‘ì—…ìë¡œ ì°¸ì—¬í•œ ìƒë‹´ì˜ ë¹„ìœ¨',
                        'ì‚°ì‹': 'í˜‘ì—… ì°¸ì—¬ ìƒë‹´ ê±´ìˆ˜ Ã· ì´ ì°¸ì—¬ ìƒë‹´ ê±´ìˆ˜'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ëŸ‰ ì§€í‘œ',
                        'ì§€í‘œëª…': 'IIF (ê°œì… ì˜í–¥ë ¥ ê³„ìˆ˜)',
                        'ì •ì˜': 'ì°¸ì—¬í•œ ëŒ€í™”ì˜ ê¸¸ì´ë¥¼ ê°€ì¤‘ì¹˜ë¡œ ë°˜ì˜í•œ ì˜í–¥ë ¥ ì§€ìˆ˜',
                        'ì‚°ì‹': 'Î£(í˜‘ì—… ì°¸ì—¬í•œ ê° ìƒë‹´ì˜ ì „ì²´ ë©”ì‹œì§€ ìˆ˜)'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì§€í‘œ',
                        'ì§€í‘œëª…': 'CIS (ì½˜í…ì¸  ì •ë³´ ì ìˆ˜)',
                        'ì •ì˜': 'í•µì‹¬ ìƒí’ˆ í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ë©”ì‹œì§€ ê°œìˆ˜',
                        'ì‚°ì‹': 'Î£(ë„ì›€ ë©”ì‹œì§€ ë‚´ í•µì‹¬ í‚¤ì›Œë“œ í¬í•¨ ê°œìˆ˜)'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì§€í‘œ',
                        'ì§€í‘œëª…': 'DLS (ì–¸ì–´ ê¹Šì´ ì ìˆ˜)',
                        'ì •ì˜': 'ë„ì›€ ë©”ì‹œì§€ì˜ í‰ê·  ê¸€ì ê¸¸ì´',
                        'ì‚°ì‹': 'ë„ì›€ ë©”ì‹œì§€ ì´ ê¸€ììˆ˜ Ã· ë„ì›€ ë©”ì‹œì§€ ì´ ê°œìˆ˜'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì§€í‘œ',
                        'ì§€í‘œëª…': 'ALS (ì‹ ì²­ì„œ ë§í¬ ì ìˆ˜)',
                        'ì •ì˜': 'ì‹ ì²­ì„œ ë§í¬ ë°œì†¡ íšŸìˆ˜ ê¸°ë°˜ ì ìˆ˜',
                        'ì‚°ì‹': 'Î£(ì‹ ì²­ì„œ ë§í¬ ë°œì†¡ íšŸìˆ˜) Ã— 10ì '
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì ìˆ˜',
                        'ì§€í‘œëª…': 'ë„ì›€ ì •ì„± ì ìˆ˜',
                        'ì •ì˜': 'ë„ì›€ ë©”ì‹œì§€ì˜ í¬ì†Œì„±ê³¼ ALS ë³´ì •ì„ ë°˜ì˜í•œ ì§ˆì  ê¸°ì—¬ë„',
                        'ì‚°ì‹': 'ê¸°ë³¸ì ìˆ˜ Ã— (1 + ì •ê·œí™”ALS Ã— 3)'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì ìˆ˜',
                        'ì§€í‘œëª…': 'ë‹´ë‹¹ ì •ì„± ì ìˆ˜',
                        'ì •ì˜': 'ë‹´ë‹¹ ë©”ì‹œì§€ì˜ í¬ì†Œì„±ì„ ë°˜ì˜í•œ ì§ˆì  ê¸°ì—¬ë„',
                        'ì‚°ì‹': 'ê¸°ë³¸ì ìˆ˜ Ã— ë¹„ìœ¨ì¡°ì •ê³„ìˆ˜'
                    },
                    {
                        'êµ¬ë¶„': 'ì •ì„± ì ìˆ˜',
                        'ì§€í‘œëª…': 'ì´ ì •ì„± ì ìˆ˜',
                        'ì •ì˜': 'ë„ì›€ ì •ì„± ì ìˆ˜ì™€ ë‹´ë‹¹ ì •ì„± ì ìˆ˜ì˜ í•©ê³„',
                        'ì‚°ì‹': 'ë„ì›€ ì •ì„± ì ìˆ˜ + ë‹´ë‹¹ ì •ì„± ì ìˆ˜'
                    }
                ];
                
                const helpWs = XLSX.utils.json_to_sheet(helpData);
                XLSX.utils.book_append_sheet(wb, helpWs, 'ë„ì›€ë§');
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                const filename = `SNSì„¼í„°_ì±„íŒ…ë¶„ì„_ê²°ê³¼_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                log(`âœ… ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${filename}`);
                
            } catch (error) {
                log(`âŒ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: ${error.message}`);
                alert('ê²°ê³¼ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
